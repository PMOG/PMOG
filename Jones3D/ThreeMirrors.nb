(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     52359,       1156]
NotebookOptionsPosition[     51926,       1136]
NotebookOutlinePosition[     52264,       1151]
CellTagsIndexPosition[     52221,       1148]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SphericalUnit", "[", 
    RowBox[{"\[Theta]_", ",", "\[Phi]_"}], "]"}], ":=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{
      RowBox[{"Cos", "[", "\[Phi]", "]"}], 
      RowBox[{"Sin", "[", "\[Theta]", "]"}]}], ",", 
     RowBox[{
      RowBox[{"Sin", "[", "\[Phi]", "]"}], 
      RowBox[{"Sin", "[", "\[Theta]", "]"}]}], ",", 
     RowBox[{"Cos", "[", "\[Theta]", "]"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SphericalBase", "[", 
    RowBox[{"\[Theta]_", ",", "\[Phi]_", ",", "\[Psi]_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"Cos", "[", "\[Phi]", "]"}], 
         RowBox[{"Cos", "[", "\[Theta]", "]"}]}], ",", 
        RowBox[{"-", 
         RowBox[{"Sin", "[", "\[Phi]", "]"}]}], ",", 
        RowBox[{
         RowBox[{"Cos", "[", "\[Phi]", "]"}], 
         RowBox[{"Sin", "[", "\[Theta]", "]"}]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"Sin", "[", "\[Phi]", "]"}], 
         RowBox[{"Cos", "[", "\[Theta]", "]"}]}], ",", 
        RowBox[{"Cos", "[", "\[Phi]", "]"}], ",", 
        RowBox[{
         RowBox[{"Sin", "[", "\[Phi]", "]"}], 
         RowBox[{"Sin", "[", "\[Theta]", "]"}]}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"Sin", "[", "\[Theta]", "]"}]}], ",", "0", ",", 
        RowBox[{"Cos", "[", "\[Theta]", "]"}]}], "}"}]}], "}"}], ".", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Cos", "[", "\[Psi]", "]"}], ",", 
        RowBox[{"-", 
         RowBox[{"Sin", "[", "\[Psi]", "]"}]}], ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Sin", "[", "\[Psi]", "]"}], ",", 
        RowBox[{"Cos", "[", "\[Psi]", "]"}], ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "1"}], "}"}]}], "}"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ReflectRefract", "[", 
    RowBox[{"u_", ",", "k0_", ",", "nt_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "s0", ",", "p0", ",", "s1", ",", "p1", ",", "k1", ",", "s2", ",", "p2", 
       ",", "k2", ",", "Q0", ",", "Q1", ",", "Q2", ",", "ci", ",", "ct", ",", 
       "rp", ",", "tp", ",", "rs", ",", "ts", ",", "P1", ",", "P2", ",", 
       "Rays"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Abs", "[", 
         RowBox[{"k0", ".", "u"}], "]"}], "\[Equal]", "1"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Normal", " ", "incidence"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"k1", "=", 
         RowBox[{"k0", "-", 
          RowBox[{"2", 
           RowBox[{"(", 
            RowBox[{"k0", ".", "u"}], ")"}], "u"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"k2", "=", "k0"}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Fresnel", " ", "Coefficients"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"r", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"nt", "-", "1"}], ")"}], "/", 
          RowBox[{"(", 
           RowBox[{"nt", "+", "1"}], ")"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"t", "=", 
         RowBox[{"2", "/", 
          RowBox[{"(", 
           RowBox[{"nt", "+", "1"}], ")"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"P1", "=", 
         RowBox[{
          RowBox[{"r", "*", 
           RowBox[{"IdentityMatrix", "[", "3", "]"}]}], "+", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"1", "-", "r"}], ")"}], 
           RowBox[{"Outer", "[", 
            RowBox[{"Times", ",", "k0", ",", "k0"}], "]"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"P2", "=", 
         RowBox[{
          RowBox[{"t", "*", 
           RowBox[{"IdentityMatrix", "[", "3", "]"}]}], "+", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"1", "-", "t"}], ")"}], 
           RowBox[{"Outer", "[", 
            RowBox[{"Times", ",", "k0", ",", "k0"}], "]"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Rays", "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"k0", ",", "k1", ",", "k2"}], "}"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Return", "[", 
         RowBox[{"{", 
          RowBox[{"Rays", ",", "P1", ",", "P2"}], "}"}], "]"}], ";"}], 
       "\[IndentingNewLine]", 
       RowBox[{"(*", "Else", "*)"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Oblique", " ", "incidence"}], "*)"}], "\[IndentingNewLine]", 
       
       RowBox[{"(*", 
        RowBox[{"k1", ":", " ", 
         RowBox[{"Reflected", " ", "ray"}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"k1", "=", 
         RowBox[{"k0", "-", 
          RowBox[{"2", 
           RowBox[{"(", 
            RowBox[{"k0", ".", "u"}], ")"}], "u"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"s0", "=", 
         RowBox[{"Normalize", "[", 
          RowBox[{"Cross", "[", 
           RowBox[{"k0", ",", "k1"}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"s1", "=", "s0"}], ";", "\[IndentingNewLine]", 
        RowBox[{"p0", "=", 
         RowBox[{"Cross", "[", 
          RowBox[{"k0", ",", "s0"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"p1", "=", 
         RowBox[{"Cross", "[", 
          RowBox[{"k1", ",", "s1"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Q0", "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"s0", ",", "p0", ",", "k0"}], "}"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Q1", "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"s1", ",", "p1", ",", "k1"}], "}"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"k2", ":", " ", 
          RowBox[{"Refracted", " ", "ray"}]}], "*)"}], "\[IndentingNewLine]", 
        
        RowBox[{"ci", "=", 
         RowBox[{"Abs", "[", 
          RowBox[{"u", ".", "k0"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"ct", "=", 
         RowBox[{"Sqrt", "[", 
          RowBox[{"1", "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "-", 
              RowBox[{"ci", "^", "2"}]}], ")"}], "/", 
            RowBox[{"nt", "^", "2"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"k2", "=", 
         RowBox[{
          RowBox[{"k0", "/", "nt"}], "+", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"ct", "-", 
             RowBox[{"ci", "/", "nt"}]}], ")"}], 
           RowBox[{"Sign", "[", 
            RowBox[{"k0", ".", "u"}], "]"}], "u"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"s2", "=", "s0"}], ";", "\[IndentingNewLine]", 
        RowBox[{"p2", "=", 
         RowBox[{"Cross", "[", 
          RowBox[{"k2", ",", "s2"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Q2", "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"s2", ",", "p2", ",", "k2"}], "}"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Fresnel", " ", "Coefficients"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"rs", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"nt", "*", "ci"}], "-", "ct"}], ")"}], "/", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"nt", "*", "ci"}], "+", "ct"}], ")"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ts", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"2", "ci"}], ")"}], "/", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"nt", "*", "ci"}], "+", "ct"}], ")"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"rp", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"ci", "-", 
            RowBox[{"nt", "*", "ct"}]}], ")"}], "/", 
          RowBox[{"(", 
           RowBox[{"ci", "+", 
            RowBox[{"nt", "*", "ct"}]}], ")"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"tp", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"2", "ci"}], ")"}], "/", 
          RowBox[{"(", 
           RowBox[{"ci", "+", 
            RowBox[{"nt", "*", "ct"}]}], ")"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Polarization", " ", "Matrices"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"P1", "=", 
         RowBox[{"Q1", ".", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"{", 
            RowBox[{"rs", ",", "rp", ",", "1"}], "}"}], "]"}], ".", 
          RowBox[{"Transpose", "[", "Q0", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"P2", "=", 
         RowBox[{"Q2", ".", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"{", 
            RowBox[{"ts", ",", "tp", ",", "1"}], "}"}], "]"}], ".", 
          RowBox[{"Transpose", "[", "Q0", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Rays", "=", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"k0", ",", "k1", ",", "k2"}], "}"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Return", "[", 
         RowBox[{"{", 
          RowBox[{"Rays", ",", "P1", ",", "P2"}], "}"}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"EPS", "=", "1*^-6"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"B", "=", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"2", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "2", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "1"}], "}"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "2", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "1"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "2", ",", "0"}], "}"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"-", "1"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "2", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"2", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"-", "1"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "2", ",", "0"}], "}"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "2", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", 
          RowBox[{"-", "1"}]}], "}"}]}], "}"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Manipulate", "[", 
  RowBox[{
   RowBox[{"Quiet", "@", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"k0", "=", 
        RowBox[{"{", 
         RowBox[{"SphericalUnit", "[", 
          RowBox[{"\[Theta]0", ",", "\[Phi]0"}], "]"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"M1", "=", 
        RowBox[{"SphericalBase", "[", 
         RowBox[{"\[Theta]1", ",", "\[Phi]1", ",", "0"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"M2", "=", 
        RowBox[{"SphericalBase", "[", 
         RowBox[{"\[Theta]2", ",", "\[Phi]2", ",", "0"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"M3", "=", 
        RowBox[{"SphericalBase", "[", 
         RowBox[{"\[Theta]3", ",", "\[Phi]3", ",", "0"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"u1", ",", "v1", ",", "w1"}], "}"}], "=", 
        RowBox[{"Transpose", "[", "M1", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"u2", ",", "v2", ",", "w2"}], "}"}], "=", 
        RowBox[{"Transpose", "[", "M2", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"u3", ",", "v3", ",", "w3"}], "}"}], "=", 
        RowBox[{"Transpose", "[", "M3", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"S", "=", 
        RowBox[{"Join", "[", 
         RowBox[{"B", ",", 
          RowBox[{"{", 
           RowBox[{"M1", ",", "M2", ",", "M3"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"p0", "=", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{"1", ",", "1", ",", "0"}], "}"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"r1", "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"-", "1"}], ",", "1", ",", "0"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"r2", "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"-", "1"}], ",", 
          RowBox[{"-", "1"}], ",", "0"}], "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"r3", "=", 
        RowBox[{"{", 
         RowBox[{"1", ",", 
          RowBox[{"-", "1"}], ",", "0"}], "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"b1", ",", "b2", ",", "b3"}], "}"}], "=", 
        RowBox[{"2", 
         RowBox[{"IdentityMatrix", "[", "3", "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"centers", "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"-", "b3"}], ",", 
          RowBox[{"-", "b2"}], ",", 
          RowBox[{"-", "b1"}], ",", "b1", ",", "b2", ",", "b3", ",", "r1", 
          ",", "r2", ",", "r3"}], "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n0", "=", "2"}], ";", "\[IndentingNewLine]", 
       RowBox[{"refidx", "=", 
        RowBox[{"{", 
         RowBox[{
         "n0", ",", "n0", ",", "n0", ",", "n0", ",", "n0", ",", "n0", ",", 
          "n1", ",", "n2", ",", "n3"}], "}"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"path", "=", 
        RowBox[{"{", "p0", "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"P", "=", 
        RowBox[{"{", 
         RowBox[{"IdentityMatrix", "[", "3", "]"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"m", "=", "1"}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"m", "\[LessEqual]", "4"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"ki", "=", 
           RowBox[{"k0", "[", 
            RowBox[{"[", "m", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"pi", "=", 
           RowBox[{"p0", "[", 
            RowBox[{"[", "m", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"j", "=", "7"}], ";", "\[IndentingNewLine]", 
          RowBox[{"its", "=", "0"}], ";", "\[IndentingNewLine]", 
          RowBox[{"While", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"its", "<", "100"}], ")"}], "&&", 
             RowBox[{"(", 
              RowBox[{"j", ">", "6"}], ")"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"L", "=", 
              RowBox[{"MapThread", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"ki", ".", "#1"}], "\[Equal]", "0"}], ",", 
                   RowBox[{"-", "100000"}], ",", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"#2", "-", "pi"}], ")"}], ".", "#1"}], "/", 
                    RowBox[{"(", 
                    RowBox[{"ki", ".", "#1"}], ")"}]}]}], "]"}], "&"}], ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"S", "[", 
                   RowBox[{"[", 
                    RowBox[{";;", ",", ";;", ",", "3"}], "]"}], "]"}], ",", 
                  "centers"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"d", "=", 
              RowBox[{
               RowBox[{"Map", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"pi", "+", 
                    RowBox[{"#", "*", "ki"}]}], ")"}], "&"}], ",", "L"}], 
                "]"}], "-", "centers"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"q", "=", 
              RowBox[{"MapThread", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"Norm", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Inverse", "[", "#1", "]"}], ".", "#2"}], ",", 
                    "Infinity"}], "]"}], "<", "1"}], ")"}], "&"}], ",", 
                RowBox[{"{", 
                 RowBox[{"S", ",", "d"}], "}"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"LL", "=", 
              RowBox[{"Pick", "[", 
               RowBox[{"L", ",", "q", ",", "True"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"j", "=", 
              RowBox[{"Position", "[", 
               RowBox[{"L", ",", 
                RowBox[{"Min", "[", 
                 RowBox[{"Select", "[", 
                  RowBox[{"LL", ",", 
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{"#", ">", "EPS"}], ")"}], "&"}]}], "]"}], "]"}]}],
                "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "[", "j", "]"}], "\[Equal]", "0"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"its", "=", "100"}], ";"}], "\[IndentingNewLine]", 
               RowBox[{"(*", "Else", "*)"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"j", "=", 
                 RowBox[{"Part", "[", 
                  RowBox[{"j", ",", "1", ",", "1"}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"pi", "=", 
                 RowBox[{"pi", "+", 
                  RowBox[{
                   RowBox[{"L", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], "*", "ki"}]}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"path", "[", 
                  RowBox[{"[", "m", "]"}], "]"}], "=", 
                 RowBox[{"Append", "[", 
                  RowBox[{
                   RowBox[{"path", "[", 
                    RowBox[{"[", "m", "]"}], "]"}], ",", "pi"}], "]"}]}], ";",
                 "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"j", ">", "6"}], ",", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"Rays", ",", "PR", ",", "PT"}], "}"}], "=", 
                    RowBox[{"ReflectRefract", "[", 
                    RowBox[{
                    RowBox[{"S", "[", 
                    RowBox[{"[", 
                    RowBox[{"j", ",", ";;", ",", "3"}], "]"}], "]"}], ",", 
                    "ki", ",", 
                    RowBox[{"refidx", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}]}], ";", " ", 
                   "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{"P", "[", 
                    RowBox[{"[", "m", "]"}], "]"}], "=", 
                    RowBox[{"PR", ".", 
                    RowBox[{"P", "[", 
                    RowBox[{"[", "m", "]"}], "]"}]}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"ki", "=", 
                    RowBox[{"Rays", "[", 
                    RowBox[{"[", 
                    RowBox[{";;", ",", "2"}], "]"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"P", "=", 
                    RowBox[{"Append", "[", 
                    RowBox[{"P", ",", "PT"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"k0", "=", 
                    RowBox[{"Append", "[", 
                    RowBox[{"k0", ",", 
                    RowBox[{"Rays", "[", 
                    RowBox[{"[", 
                    RowBox[{";;", ",", "3"}], "]"}], "]"}]}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"p0", "=", 
                    RowBox[{"Append", "[", 
                    RowBox[{"p0", ",", "pi"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"path", "=", 
                    RowBox[{"Append", "[", 
                    RowBox[{"path", ",", 
                    RowBox[{"{", "pi", "}"}]}], "]"}]}], ";"}]}], 
                 "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]",
               "]"}], ";", "\[IndentingNewLine]", 
             RowBox[{"its", "=", 
              RowBox[{"its", "+", "1"}]}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"m", "=", 
           RowBox[{"m", "+", "1"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"Show", "[", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Graphics3D", "[", 
              RowBox[{"{", 
               RowBox[{"Red", ",", 
                RowBox[{"Arrow", "[", "#", "]"}]}], "}"}], "]"}], "&"}], "/@", 
            RowBox[{"(", "path", ")"}]}], ",", 
           RowBox[{"{", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Graphics3D", "[", 
              RowBox[{"{", 
               RowBox[{"Black", ",", 
                RowBox[{"Arrow", "[", 
                 RowBox[{"{", 
                  RowBox[{"r1", ",", 
                   RowBox[{"r1", "+", "w1"}]}], "}"}], "]"}]}], "}"}], "]"}], 
             ",", "\[IndentingNewLine]", 
             RowBox[{"Graphics3D", "[", 
              RowBox[{"{", 
               RowBox[{"Black", ",", 
                RowBox[{"Arrow", "[", 
                 RowBox[{"{", 
                  RowBox[{"r2", ",", 
                   RowBox[{"r2", "+", "w2"}]}], "}"}], "]"}]}], "}"}], "]"}], 
             ",", "\[IndentingNewLine]", 
             RowBox[{"Graphics3D", "[", 
              RowBox[{"{", 
               RowBox[{"Black", ",", 
                RowBox[{"Arrow", "[", 
                 RowBox[{"{", 
                  RowBox[{"r3", ",", 
                   RowBox[{"r3", "+", "w3"}]}], "}"}], "]"}]}], "}"}], "]"}], 
             ",", "\[IndentingNewLine]", 
             RowBox[{"ParametricPlot3D", "[", 
              RowBox[{
               RowBox[{"r1", "+", 
                RowBox[{"\[Lambda]", "*", "u1"}], "+", 
                RowBox[{"\[Mu]", "*", "v1"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Lambda]", ",", 
                 RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Mu]", ",", 
                 RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
               RowBox[{"Mesh", "\[Rule]", "None"}], ",", 
               RowBox[{"PlotStyle", "\[Rule]", 
                RowBox[{"Directive", "[", 
                 RowBox[{"Red", ",", 
                  RowBox[{"Opacity", "[", "0.5", "]"}]}], "]"}]}]}], "]"}], 
             ",", "\[IndentingNewLine]", 
             RowBox[{"ParametricPlot3D", "[", 
              RowBox[{
               RowBox[{"r2", "+", 
                RowBox[{"\[Lambda]", "*", "u2"}], "+", 
                RowBox[{"\[Mu]", "*", "v2"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Lambda]", ",", 
                 RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Mu]", ",", 
                 RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
               RowBox[{"Mesh", "\[Rule]", "None"}], ",", 
               RowBox[{"PlotStyle", "\[Rule]", 
                RowBox[{"Directive", "[", 
                 RowBox[{"Green", ",", 
                  RowBox[{"Opacity", "[", "0.5", "]"}]}], "]"}]}]}], "]"}], 
             ",", "\[IndentingNewLine]", 
             RowBox[{"ParametricPlot3D", "[", 
              RowBox[{
               RowBox[{"r3", "+", 
                RowBox[{"\[Lambda]", "*", "u3"}], "+", 
                RowBox[{"\[Mu]", "*", "v3"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Lambda]", ",", 
                 RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"\[Mu]", ",", 
                 RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
               RowBox[{"Mesh", "\[Rule]", "None"}], ",", 
               RowBox[{"PlotStyle", "\[Rule]", 
                RowBox[{"Directive", "[", 
                 RowBox[{"Blue", ",", 
                  RowBox[{"Opacity", "[", "0.5", "]"}]}], "]"}]}]}], "]"}]}], 
            "\[IndentingNewLine]", "}"}]}], "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{"PlotRange", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"-", "2"}], ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"-", "2"}], ",", "2"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"-", "2"}], ",", "2"}], "}"}]}], "}"}]}], ",", 
         RowBox[{"Axes", "\[Rule]", "True"}], ",", 
         RowBox[{"AxesLabel", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<x\>\"", ",", "\"\<y\>\"", ",", "\"\<z\>\""}], 
           "}"}]}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]0", ",", 
       RowBox[{"\[Pi]", "/", "2"}]}], "}"}], ",", "0", ",", "\[Pi]"}], "}"}], 
   ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Phi]0", ",", "\[Pi]"}], "}"}], ",", "0", ",", 
     RowBox[{"2", "\[Pi]"}]}], "}"}], ",", "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]1", ",", 
       RowBox[{"\[Pi]", "/", "2"}]}], "}"}], ",", "0", ",", "\[Pi]"}], "}"}], 
   ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Phi]1", ",", 
       RowBox[{
        RowBox[{"7", "/", "4"}], "\[Pi]"}]}], "}"}], ",", "0", ",", 
     RowBox[{"2", "\[Pi]"}]}], "}"}], ",", "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]2", ",", 
       RowBox[{"\[Pi]", "/", "2"}]}], "}"}], ",", "0", ",", "\[Pi]"}], "}"}], 
   ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Phi]2", ",", 
       RowBox[{
        RowBox[{"1", "/", "4"}], "\[Pi]"}]}], "}"}], ",", "0", ",", 
     RowBox[{"2", "\[Pi]"}]}], "}"}], ",", "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Theta]3", ",", 
       RowBox[{"\[Pi]", "/", "2"}]}], "}"}], ",", "0", ",", "\[Pi]"}], "}"}], 
   ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"\[Phi]3", ",", 
       RowBox[{
        RowBox[{"3", "/", "4"}], "\[Pi]"}]}], "}"}], ",", "0", ",", 
     RowBox[{"2", "\[Pi]"}]}], "}"}], ",", "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n1", ",", "1.5"}], "}"}], ",", "0", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n2", ",", "1.5"}], "}"}], ",", "0", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n3", ",", "1.5"}], "}"}], ",", "0", ",", "2"}], "}"}]}], 
  "]"}]}], "Input",
 CellChangeTimes->{{3.695663309243862*^9, 3.695663320497797*^9}, {
   3.695663559564149*^9, 3.6956637692684917`*^9}, {3.695663806956051*^9, 
   3.695663917993663*^9}, {3.6956639795915318`*^9, 3.695663999730899*^9}, {
   3.69566404212313*^9, 3.6956640507259808`*^9}, 3.6956641230467453`*^9, {
   3.695664160392598*^9, 3.695664172639114*^9}, {3.695664372433238*^9, 
   3.695664403180629*^9}, {3.695664531063369*^9, 3.695664549953582*^9}, {
   3.6956648050006104`*^9, 3.695664809857439*^9}, {3.6956648585020933`*^9, 
   3.695664862222844*^9}, {3.695664913885857*^9, 3.6956649298115063`*^9}, {
   3.6956650620479517`*^9, 3.6956650658229847`*^9}, {3.695665254046226*^9, 
   3.69566531093364*^9}, {3.695665342408135*^9, 3.6956653919167757`*^9}, {
   3.6956671901671877`*^9, 3.6956674786382713`*^9}, {3.695667522829321*^9, 
   3.695667532852387*^9}, 3.695667618381579*^9, {3.695667668215263*^9, 
   3.695667683347299*^9}, {3.6956677464492073`*^9, 3.695667792184722*^9}, {
   3.695676150977611*^9, 3.69567617995853*^9}, {3.6956773923857403`*^9, 
   3.695677395632348*^9}, 3.695677547639853*^9, {3.695678111360485*^9, 
   3.6956781484599333`*^9}, {3.695678209224308*^9, 3.6956782193961897`*^9}, 
   3.695678258481763*^9, {3.6956783235324183`*^9, 3.69567835935655*^9}, {
   3.695678402030529*^9, 3.695678402436788*^9}, {3.695681384365377*^9, 
   3.695681393846143*^9}, {3.6956857971975117`*^9, 3.695685798378562*^9}, {
   3.695688472681122*^9, 3.69568849324151*^9}, {3.695689120418659*^9, 
   3.695689137362965*^9}, {3.695689185482458*^9, 3.69568967474631*^9}, {
   3.695689719459695*^9, 3.695689983919797*^9}, {3.69569011109195*^9, 
   3.6956901333471117`*^9}, {3.695690215778777*^9, 3.6956902288388042`*^9}, {
   3.695690273211533*^9, 3.6956903471780777`*^9}, {3.695690457100395*^9, 
   3.695690610466384*^9}, {3.69569069883687*^9, 3.695690956178089*^9}, {
   3.695691023963522*^9, 3.6956910635159903`*^9}, {3.6956911589771338`*^9, 
   3.695691213576782*^9}, {3.695691729510457*^9, 3.695691805383651*^9}, {
   3.695691898159727*^9, 3.695691918051593*^9}, {3.695692008787616*^9, 
   3.695692010465747*^9}, {3.6956921639574614`*^9, 3.695692231135741*^9}, 
   3.695692455125339*^9, {3.695692818084531*^9, 3.6956929813075247`*^9}, {
   3.695693025560192*^9, 3.695693082134879*^9}, {3.695693113023305*^9, 
   3.69569315276145*^9}, {3.695693216285404*^9, 3.6956933642527027`*^9}, {
   3.695693429231073*^9, 3.6956934504262247`*^9}, {3.695693527999262*^9, 
   3.695693529716906*^9}, {3.695693640074473*^9, 3.695693782960374*^9}, {
   3.6956939041067133`*^9, 3.6956940163909397`*^9}, {3.695694091473597*^9, 
   3.695694117643962*^9}, {3.69569418296875*^9, 3.6956941940456877`*^9}, {
   3.695694342798766*^9, 3.6956944264062757`*^9}, {3.695694481614994*^9, 
   3.695694645966422*^9}, {3.6956946866392527`*^9, 3.695694717835547*^9}, {
   3.695694920503064*^9, 3.695694936524234*^9}, 3.695694989750807*^9, {
   3.695695181842469*^9, 3.6956952591171017`*^9}, {3.695697261829194*^9, 
   3.695697265720312*^9}, {3.695697377371298*^9, 3.6956973803245897`*^9}, {
   3.6956975061787167`*^9, 3.695697508960781*^9}, {3.6956976732418633`*^9, 
   3.6956976750327168`*^9}, 3.695698238502033*^9, {3.695698276197134*^9, 
   3.695698290942853*^9}, {3.695698358518251*^9, 3.695698367175702*^9}, {
   3.695698473286996*^9, 3.6956985183863783`*^9}, {3.695698604783638*^9, 
   3.695698621068151*^9}, {3.69569871931518*^9, 3.695698742189746*^9}, {
   3.695698779046997*^9, 3.6956988658224087`*^9}, {3.6956989353731937`*^9, 
   3.695698937040975*^9}, {3.6956989989367037`*^9, 3.695699003470264*^9}, 
   3.6956993868234177`*^9, 3.695699719896929*^9, {3.6956998986799717`*^9, 
   3.6956999034891033`*^9}, 3.695700118388315*^9, {3.695700363667239*^9, 
   3.6957003707286053`*^9}, {3.695700488665433*^9, 3.695700534133944*^9}, {
   3.695700596453979*^9, 3.6957006139013577`*^9}, {3.6957007051625023`*^9, 
   3.6957007279416237`*^9}, {3.6957007587947273`*^9, 3.695700758887578*^9}, 
   3.6957008918720627`*^9, {3.695701048390256*^9, 3.6957010701356993`*^9}, {
   3.69570110397906*^9, 3.6957011096394873`*^9}, {3.6957011448678102`*^9, 
   3.6957011450578413`*^9}, {3.695701257669434*^9, 3.695701313716563*^9}, {
   3.695701414043988*^9, 3.695701416201571*^9}, {3.695701481036119*^9, 
   3.6957014871396523`*^9}, {3.695701647539864*^9, 3.6957016478024197`*^9}, 
   3.695702140740499*^9, {3.695702336028249*^9, 3.695702336652255*^9}, 
   3.695702399894343*^9, {3.6957026081087027`*^9, 3.695702660775633*^9}, {
   3.695702724873065*^9, 3.69570274117041*^9}, {3.695702783333552*^9, 
   3.695702813165053*^9}, {3.695702893899559*^9, 3.695702900849497*^9}, {
   3.695702933893079*^9, 3.695702943435268*^9}, {3.695702981863635*^9, 
   3.6957030729039593`*^9}, {3.6957031144121723`*^9, 3.695703114631094*^9}, {
   3.695727134346449*^9, 3.695727183353898*^9}, {3.6957272566816473`*^9, 
   3.6957273034908133`*^9}, {3.6957276121203814`*^9, 3.695727615363844*^9}, {
   3.695727768825706*^9, 3.69572781662407*^9}, {3.695728384467928*^9, 
   3.695728385596464*^9}, 3.695728417764214*^9, {3.6957285781284637`*^9, 
   3.6957285787388678`*^9}, {3.695728753750229*^9, 3.6957287594928017`*^9}, {
   3.695728875336128*^9, 3.6957288831440487`*^9}, {3.695728949176746*^9, 
   3.6957289585369873`*^9}, {3.695729025579973*^9, 3.695729031457849*^9}, {
   3.695729063910069*^9, 3.695729068916049*^9}, 3.695729155874537*^9, {
   3.6957292896457567`*^9, 3.6957292917313557`*^9}, {3.6957293219528923`*^9, 
   3.695729324029669*^9}, 3.701622051802857*^9, {3.701622358927799*^9, 
   3.701622510324482*^9}, {3.701622603033215*^9, 3.701622782995887*^9}, {
   3.70162291155221*^9, 3.701622930292186*^9}, {3.701623270576461*^9, 
   3.7016233659006977`*^9}, {3.7016235228587933`*^9, 3.7016235744784737`*^9}, 
   3.7016236075164747`*^9, {3.701623713975377*^9, 3.701623715904273*^9}, {
   3.701623781709463*^9, 3.701623803807426*^9}, {3.701625667776462*^9, 
   3.701625710495141*^9}, {3.7016261396122627`*^9, 3.701626159550157*^9}, 
   3.701628442922727*^9, 3.70162853036187*^9, {3.7016292347794027`*^9, 
   3.701629513692987*^9}, {3.701629696374428*^9, 3.701629697987493*^9}, {
   3.701629834685322*^9, 3.70162985904431*^9}, {3.701629989289727*^9, 
   3.701630011193266*^9}, {3.7016300472308702`*^9, 3.7016300676831512`*^9}, {
   3.7016301146130753`*^9, 3.701630204883151*^9}, {3.701630249359593*^9, 
   3.70163028165084*^9}, {3.701630417119028*^9, 3.701630602490706*^9}, {
   3.7016306626475277`*^9, 3.7016308718058558`*^9}, 3.701630921167513*^9, 
   3.701630958792674*^9, {3.701631044471355*^9, 3.701631133966515*^9}, {
   3.70163119159352*^9, 3.701631192179913*^9}, {3.701631231138753*^9, 
   3.701631253107134*^9}, {3.701631289633829*^9, 3.701631292822938*^9}, {
   3.70163132293215*^9, 3.701631324201703*^9}, {3.701631368180533*^9, 
   3.701631550224154*^9}, {3.701631596045938*^9, 3.7016315963987827`*^9}, {
   3.701631641017632*^9, 3.701631659898036*^9}, {3.7016318242634783`*^9, 
   3.701631961793498*^9}, {3.701632018794057*^9, 3.701632069939075*^9}, {
   3.70163224606256*^9, 3.701632277582417*^9}, {3.701632360445959*^9, 
   3.701632388698868*^9}, {3.7016324300580807`*^9, 3.701632450612406*^9}, {
   3.7016324943703327`*^9, 3.701632565908565*^9}, 3.701632830493144*^9, {
   3.701632889950131*^9, 3.701632919649426*^9}, {3.701632985725484*^9, 
   3.701633008122641*^9}, {3.701633086641267*^9, 3.701633096983684*^9}, {
   3.701633186340723*^9, 3.701633210005045*^9}, {3.7016332530407248`*^9, 
   3.70163326743159*^9}, {3.701633318698876*^9, 3.701633544551071*^9}, {
   3.701633579700658*^9, 3.701633644916191*^9}, {3.701633678350339*^9, 
   3.701634060654797*^9}, {3.701634099739345*^9, 3.7016341447476*^9}, {
   3.701634247269351*^9, 3.701634389784688*^9}, {3.7016344259673977`*^9, 
   3.701634434722928*^9}, {3.701634474827154*^9, 3.701634485893292*^9}, {
   3.701634558235238*^9, 3.701634648478245*^9}, {3.7016347974994392`*^9, 
   3.70163482705684*^9}, {3.701635319243465*^9, 3.7016353483573933`*^9}, {
   3.701635397923039*^9, 3.701635464656693*^9}, {3.701635542335372*^9, 
   3.701635599626309*^9}, {3.7016356875171337`*^9, 3.701635687997017*^9}, {
   3.701635744532627*^9, 3.701635747133205*^9}, {3.7016358848706284`*^9, 
   3.7016359111999474`*^9}, {3.701636035238124*^9, 3.701636038912578*^9}, {
   3.701636091816286*^9, 3.701636113299172*^9}, {3.701636396094829*^9, 
   3.701636405337887*^9}, {3.701636469075354*^9, 3.7016364787593393`*^9}, {
   3.701636837839485*^9, 3.701636867675003*^9}, {3.7016369547883472`*^9, 
   3.701637017454657*^9}, {3.701637076527495*^9, 3.701637092582127*^9}, {
   3.701637164243052*^9, 3.7016371797856007`*^9}, 3.701637244713079*^9, {
   3.701637293942173*^9, 3.701637297640402*^9}, {3.701637501452693*^9, 
   3.701637540994927*^9}, {3.7016376854851227`*^9, 3.701637700194195*^9}, 
   3.701637734504342*^9, {3.7016377660598*^9, 3.701637766429948*^9}, {
   3.7016379142138433`*^9, 3.701637990367529*^9}, {3.701638051065907*^9, 
   3.701638098480389*^9}, 3.7016381389851027`*^9, {3.701638320322727*^9, 
   3.701638353081571*^9}, {3.701638447396517*^9, 3.701638525174213*^9}, {
   3.701638580182357*^9, 3.701638603695876*^9}, {3.7016386482930937`*^9, 
   3.7016386513733673`*^9}, 3.701638707587962*^9, {3.701638761757633*^9, 
   3.701638800638187*^9}, {3.701639331723557*^9, 3.701639356521208*^9}, 
   3.70164099049853*^9, {3.701641080395234*^9, 3.7016410919018993`*^9}, {
   3.7016423554939737`*^9, 3.7016423559954157`*^9}}],

Cell[BoxData[
 TagBox[
  StyleBox[
   DynamicModuleBox[{$CellContext`n1$$ = 1.5, $CellContext`n2$$ = 
    1.5, $CellContext`n3$$ = 1.5, $CellContext`\[Theta]0$$ = Rational[1, 2] 
    Pi, $CellContext`\[Theta]1$$ = Rational[1, 2] 
    Pi, $CellContext`\[Theta]2$$ = Rational[1, 2] 
    Pi, $CellContext`\[Theta]3$$ = Rational[1, 2] Pi, $CellContext`\[Phi]0$$ =
     Pi, $CellContext`\[Phi]1$$ = Rational[7, 4] Pi, $CellContext`\[Phi]2$$ = 
    Rational[1, 4] Pi, $CellContext`\[Phi]3$$ = Rational[3, 4] Pi, 
    Typeset`show$$ = True, Typeset`bookmarkList$$ = {}, 
    Typeset`bookmarkMode$$ = "Menu", Typeset`animator$$, Typeset`animvar$$ = 
    1, Typeset`name$$ = "\"untitled\"", Typeset`specs$$ = {{{
       Hold[$CellContext`\[Theta]0$$], Rational[1, 2] Pi}, 0, Pi}, {{
       Hold[$CellContext`\[Phi]0$$], Pi}, 0, 2 Pi}, {{
       Hold[$CellContext`\[Theta]1$$], Rational[1, 2] Pi}, 0, Pi}, {{
       Hold[$CellContext`\[Phi]1$$], Rational[7, 4] Pi}, 0, 2 Pi}, {{
       Hold[$CellContext`\[Theta]2$$], Rational[1, 2] Pi}, 0, Pi}, {{
       Hold[$CellContext`\[Phi]2$$], Rational[1, 4] Pi}, 0, 2 Pi}, {{
       Hold[$CellContext`\[Theta]3$$], Rational[1, 2] Pi}, 0, Pi}, {{
       Hold[$CellContext`\[Phi]3$$], Rational[3, 4] Pi}, 0, 2 Pi}, {{
       Hold[$CellContext`n1$$], 1.5}, 0, 2}, {{
       Hold[$CellContext`n2$$], 1.5}, 0, 2}, {{
       Hold[$CellContext`n3$$], 1.5}, 0, 2}}, Typeset`size$$ = {
    360., {204., 209.}}, Typeset`update$$ = 0, Typeset`initDone$$, 
    Typeset`skipInitDone$$ = True, $CellContext`\[Theta]0$4234782$$ = 
    0, $CellContext`\[Phi]0$4234783$$ = 0, $CellContext`\[Theta]1$4234784$$ = 
    0, $CellContext`\[Phi]1$4234785$$ = 0, $CellContext`\[Theta]2$4234786$$ = 
    0, $CellContext`\[Phi]2$4234787$$ = 0, $CellContext`\[Theta]3$4234788$$ = 
    0, $CellContext`\[Phi]3$4234789$$ = 0, $CellContext`n1$4234790$$ = 
    0, $CellContext`n2$4234791$$ = 0}, 
    DynamicBox[Manipulate`ManipulateBoxes[
     1, StandardForm, 
      "Variables" :> {$CellContext`n1$$ = 1.5, $CellContext`n2$$ = 
        1.5, $CellContext`n3$$ = 1.5, $CellContext`\[Theta]0$$ = 
        Rational[1, 2] Pi, $CellContext`\[Theta]1$$ = 
        Rational[1, 2] Pi, $CellContext`\[Theta]2$$ = 
        Rational[1, 2] Pi, $CellContext`\[Theta]3$$ = 
        Rational[1, 2] Pi, $CellContext`\[Phi]0$$ = 
        Pi, $CellContext`\[Phi]1$$ = 
        Rational[7, 4] Pi, $CellContext`\[Phi]2$$ = 
        Rational[1, 4] Pi, $CellContext`\[Phi]3$$ = Rational[3, 4] Pi}, 
      "ControllerVariables" :> {
        Hold[$CellContext`\[Theta]0$$, $CellContext`\[Theta]0$4234782$$, 0], 
        Hold[$CellContext`\[Phi]0$$, $CellContext`\[Phi]0$4234783$$, 0], 
        Hold[$CellContext`\[Theta]1$$, $CellContext`\[Theta]1$4234784$$, 0], 
        Hold[$CellContext`\[Phi]1$$, $CellContext`\[Phi]1$4234785$$, 0], 
        Hold[$CellContext`\[Theta]2$$, $CellContext`\[Theta]2$4234786$$, 0], 
        Hold[$CellContext`\[Phi]2$$, $CellContext`\[Phi]2$4234787$$, 0], 
        Hold[$CellContext`\[Theta]3$$, $CellContext`\[Theta]3$4234788$$, 0], 
        Hold[$CellContext`\[Phi]3$$, $CellContext`\[Phi]3$4234789$$, 0], 
        Hold[$CellContext`n1$$, $CellContext`n1$4234790$$, 0], 
        Hold[$CellContext`n2$$, $CellContext`n2$4234791$$, 0]}, 
      "OtherVariables" :> {
       Typeset`show$$, Typeset`bookmarkList$$, Typeset`bookmarkMode$$, 
        Typeset`animator$$, Typeset`animvar$$, Typeset`name$$, 
        Typeset`specs$$, Typeset`size$$, Typeset`update$$, Typeset`initDone$$,
         Typeset`skipInitDone$$}, "Body" :> Quiet[
        Module[{}, $CellContext`k0 = {
            $CellContext`SphericalUnit[$CellContext`\[Theta]0$$, \
$CellContext`\[Phi]0$$]}; $CellContext`M1 = \
$CellContext`SphericalBase[$CellContext`\[Theta]1$$, $CellContext`\[Phi]1$$, 
            0]; $CellContext`M2 = $CellContext`SphericalBase[$CellContext`\
\[Theta]2$$, $CellContext`\[Phi]2$$, 
            0]; $CellContext`M3 = $CellContext`SphericalBase[$CellContext`\
\[Theta]3$$, $CellContext`\[Phi]3$$, 
            0]; {$CellContext`u1, $CellContext`v1, $CellContext`w1} = 
          Transpose[$CellContext`M1]; {$CellContext`u2, $CellContext`v2, \
$CellContext`w2} = 
          Transpose[$CellContext`M2]; {$CellContext`u3, $CellContext`v3, \
$CellContext`w3} = Transpose[$CellContext`M3]; $CellContext`S = 
          Join[$CellContext`B, {$CellContext`M1, $CellContext`M2, \
$CellContext`M3}]; $CellContext`p0 = {{1, 1, 0}}; $CellContext`r1 = {-1, 1, 
           0}; $CellContext`r2 = {-1, -1, 0}; $CellContext`r3 = {1, -1, 
           0}; {$CellContext`b1, $CellContext`b2, $CellContext`b3} = 
          2 IdentityMatrix[
            3]; $CellContext`centers = {-$CellContext`b3, -$CellContext`b2, \
-$CellContext`b1, $CellContext`b1, $CellContext`b2, $CellContext`b3, \
$CellContext`r1, $CellContext`r2, $CellContext`r3}; $CellContext`n0 = 
          2; $CellContext`refidx = {$CellContext`n0, $CellContext`n0, \
$CellContext`n0, $CellContext`n0, $CellContext`n0, $CellContext`n0, \
$CellContext`n1$$, $CellContext`n2$$, $CellContext`n3$$}; $CellContext`path = \
{$CellContext`p0}; $CellContext`P = {
            IdentityMatrix[3]}; $CellContext`m = 1; 
         While[$CellContext`m <= 
           4, $CellContext`ki = 
            Part[$CellContext`k0, $CellContext`m]; $CellContext`pi = 
            Part[$CellContext`p0, $CellContext`m]; $CellContext`j = 
            7; $CellContext`its = 0; While[
             
             And[$CellContext`its < 100, $CellContext`j > 6], $CellContext`L = 
              MapThread[
               If[Dot[$CellContext`ki, #] == 0, -100000, 
                 Dot[#2 - $CellContext`pi, #]/Dot[$CellContext`ki, #]]& , {
                 Part[$CellContext`S, 
                  Span[1, All], 
                  Span[1, All], 3], $CellContext`centers}]; $CellContext`d = 
              Map[$CellContext`pi + # $CellContext`ki& , $CellContext`L] - \
$CellContext`centers; $CellContext`q = MapThread[Norm[
                  Dot[
                   Inverse[#], #2], Infinity] < 
                1& , {$CellContext`S, $CellContext`d}]; $CellContext`LL = 
              Pick[$CellContext`L, $CellContext`q, True]; $CellContext`j = 
              Position[$CellContext`L, 
                Min[
                 Select[$CellContext`LL, # > $CellContext`EPS& ]]]; 
             If[Length[$CellContext`j] == 0, $CellContext`its = 100; 
               Null, $CellContext`j = 
                Part[$CellContext`j, 1, 1]; $CellContext`pi = $CellContext`pi + 
                 Part[$CellContext`L, $CellContext`j] $CellContext`ki; 
               Part[$CellContext`path, $CellContext`m] = Append[
                  Part[$CellContext`path, $CellContext`m], $CellContext`pi]; 
               If[$CellContext`j > 
                 6, {$CellContext`Rays, $CellContext`PR, $CellContext`PT} = \
$CellContext`ReflectRefract[
                    Part[$CellContext`S, $CellContext`j, 
                    Span[1, All], 3], $CellContext`ki, 
                    Part[$CellContext`refidx, $CellContext`j]]; 
                 Part[$CellContext`P, $CellContext`m] = Dot[$CellContext`PR, 
                    Part[$CellContext`P, $CellContext`m]]; $CellContext`ki = 
                  Part[$CellContext`Rays, 
                    Span[1, All], 2]; $CellContext`P = 
                  Append[$CellContext`P, $CellContext`PT]; $CellContext`k0 = 
                  Append[$CellContext`k0, 
                    Part[$CellContext`Rays, 
                    Span[1, All], 3]]; $CellContext`p0 = 
                  Append[$CellContext`p0, $CellContext`pi]; $CellContext`path = 
                  Append[$CellContext`path, {$CellContext`pi}]; Null]; 
               Null]; $CellContext`its = $CellContext`its + 1; 
             Null]; $CellContext`m = $CellContext`m + 1; Null]; Show[
           Join[
            Map[Graphics3D[{Red, 
               Arrow[#]}]& , $CellContext`path], {
             Graphics3D[{Black, 
               Arrow[{$CellContext`r1, $CellContext`r1 + $CellContext`w1}]}], 
             
             Graphics3D[{Black, 
               Arrow[{$CellContext`r2, $CellContext`r2 + $CellContext`w2}]}], 
             
             Graphics3D[{Black, 
               Arrow[{$CellContext`r3, $CellContext`r3 + $CellContext`w3}]}], 
             
             
             ParametricPlot3D[$CellContext`r1 + $CellContext`\[Lambda] \
$CellContext`u1 + $CellContext`\[Mu] $CellContext`v1, \
{$CellContext`\[Lambda], -1, 1}, {$CellContext`\[Mu], -1, 1}, Mesh -> None, 
              PlotStyle -> Directive[Red, 
                Opacity[0.5]]], 
             
             ParametricPlot3D[$CellContext`r2 + $CellContext`\[Lambda] \
$CellContext`u2 + $CellContext`\[Mu] $CellContext`v2, \
{$CellContext`\[Lambda], -1, 1}, {$CellContext`\[Mu], -1, 1}, Mesh -> None, 
              PlotStyle -> Directive[Green, 
                Opacity[0.5]]], 
             
             ParametricPlot3D[$CellContext`r3 + $CellContext`\[Lambda] \
$CellContext`u3 + $CellContext`\[Mu] $CellContext`v3, \
{$CellContext`\[Lambda], -1, 1}, {$CellContext`\[Mu], -1, 1}, Mesh -> None, 
              PlotStyle -> Directive[Blue, 
                Opacity[0.5]]]}], PlotRange -> {{-2, 2}, {-2, 2}, {-2, 2}}, 
           Axes -> True, AxesLabel -> {"x", "y", "z"}]]], 
      "Specifications" :> {{{$CellContext`\[Theta]0$$, Rational[1, 2] Pi}, 0, 
         Pi}, {{$CellContext`\[Phi]0$$, Pi}, 0, 2 
         Pi}, {{$CellContext`\[Theta]1$$, Rational[1, 2] Pi}, 0, 
         Pi}, {{$CellContext`\[Phi]1$$, Rational[7, 4] Pi}, 0, 2 
         Pi}, {{$CellContext`\[Theta]2$$, Rational[1, 2] Pi}, 0, 
         Pi}, {{$CellContext`\[Phi]2$$, Rational[1, 4] Pi}, 0, 2 
         Pi}, {{$CellContext`\[Theta]3$$, Rational[1, 2] Pi}, 0, 
         Pi}, {{$CellContext`\[Phi]3$$, Rational[3, 4] Pi}, 0, 2 
         Pi}, {{$CellContext`n1$$, 1.5}, 0, 2}, {{$CellContext`n2$$, 1.5}, 0, 
         2}, {{$CellContext`n3$$, 1.5}, 0, 2}}, "Options" :> {}, 
      "DefaultOptions" :> {}],
     ImageSizeCache->{641., {234., 241.}},
     SingleEvaluation->True],
    Deinitialization:>None,
    DynamicModuleValues:>{},
    SynchronousInitialization->True,
    UndoTrackedVariables:>{Typeset`show$$, Typeset`bookmarkMode$$},
    UnsavedVariables:>{Typeset`initDone$$},
    UntrackedVariables:>{Typeset`size$$}], "Manipulate",
   Deployed->True,
   StripOnInput->False],
  Manipulate`InterpretManipulate[1]]], "Output",
 CellChangeTimes->{{3.701634806612617*^9, 3.701634828314608*^9}, 
   3.7016353055624533`*^9, 3.7016353491453133`*^9, 3.70163540220212*^9, 
   3.7016354666926394`*^9, {3.701635582021195*^9, 3.701635602862874*^9}, 
   3.701635688745063*^9, 3.701635749500511*^9, 3.701635931799369*^9, 
   3.701636040077479*^9, {3.7016360928133507`*^9, 3.701636113736718*^9}, {
   3.7016363988203163`*^9, 3.7016364071404133`*^9}, {3.70163647133526*^9, 
   3.701636479833064*^9}, 3.7016366257878103`*^9, {3.701636840906056*^9, 
   3.701636868743889*^9}, {3.70163698957841*^9, 3.70163701811747*^9}, 
   3.701637093636909*^9, {3.701637165230979*^9, 3.701637180455449*^9}, {
   3.701637284253181*^9, 3.701637302137034*^9}, 3.701637502384027*^9, 
   3.7016375658615847`*^9, {3.701637705529839*^9, 3.701637735085992*^9}, {
   3.701637962510334*^9, 3.701637991168153*^9}, {3.70163805400289*^9, 
   3.701638081002282*^9}, 3.7016381400925007`*^9, 3.701638362957094*^9, {
   3.701638510613636*^9, 3.701638526125264*^9}, 3.7016386179327173`*^9, 
   3.701638652108066*^9, {3.701638791440692*^9, 3.701638802881538*^9}, 
   3.7016393347303667`*^9, 3.701639365117861*^9, 3.701639881813568*^9, 
   3.701640970416144*^9, {3.7016410808631907`*^9, 3.701641092644849*^9}, 
   3.701642359575242*^9, 3.701647320055799*^9, 3.70165385514118*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"MatrixForm", "[", 
  RowBox[{"P", "[", 
   RowBox[{"[", "1", "]"}], "]"}], "]"}]], "Input",
 CellChangeTimes->{{3.701635324935471*^9, 3.701635343602107*^9}, {
  3.701635407751308*^9, 3.701635407887321*^9}, {3.7016359869281693`*^9, 
  3.701636006629952*^9}, {3.701636044285027*^9, 3.701636069471537*^9}}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {
      RowBox[{"-", "0.943026061173501`"}], 
      RowBox[{"-", "8.137554727128168`*^-6"}], "0.07123685673797572`"},
     {"0.3039156163805714`", 
      RowBox[{"-", "0.00002489081354906809`"}], 
      RowBox[{"-", "0.0229602867677959`"}]},
     {"0.11253007791959793`", 
      RowBox[{"-", "9.705401082994425`*^-7"}], 
      RowBox[{"-", "0.008500771104096359`"}]}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{{3.70163532608387*^9, 3.701635344651676*^9}, 
   3.701635408275804*^9, 3.701635863817409*^9, {3.701635991594788*^9, 
   3.701636006969162*^9}, {3.701636042147214*^9, 3.701636131852413*^9}, 
   3.70163626150373*^9, {3.701641255808361*^9, 3.70164128639644*^9}, 
   3.7016474125849743`*^9}]
}, Open  ]]
},
WindowSize->{943, 1028},
WindowMargins->{{0, Automatic}, {0, Automatic}},
FrontEndVersion->"11.0 for Linux x86 (64-bit) (September 21, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 38035, 867, 2828, "Input"],
Cell[38618, 891, 11694, 200, 492, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[50349, 1096, 327, 6, 32, "Input"],
Cell[50679, 1104, 1231, 29, 88, "Output"]
}, Open  ]]
}
]
*)

